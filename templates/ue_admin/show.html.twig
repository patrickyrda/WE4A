{% extends 'base.html.twig' %}
{% block title %}Détails UE{% endblock %}

{% block body %}
  <h1>Détails de l’UE</h1>

  <table class="table mb-4">
    <tr>
      <th>Code</th>
      <td>{{ u_e.code }}</td>
    </tr>
    <tr>
      <th>Titre</th>
      <td>{{ u_e.title }}</td>
    </tr>
    {% if u_e.imagePath %}
      <tr>
        <th>Image</th>
        <td>
          <img src="{{ u_e.imagePath }}" alt="" style="max-height:100px">
        </td>
      </tr>
    {% endif %}
  </table>

  <a class="btn btn-primary" href="{{ path('app_u_e_admin_edit', {'id': u_e.id}) }}">
    Modifier
  </a>
  {{ include('ue_admin/_delete_form.html.twig', {ue: u_e}) }}
  <a class="btn btn-secondary" href="{{ path('app_admin_dashboard') }}">
    ← Retour à la liste
  </a>

  {# ——— Section AJAX pour l’ajout d’un étudiant ——— #}
  <hr>
  <h2>Ajouter un étudiant</h2>
  <div data-controller="ue-show">
    <div class="input-group mb-3">
      <select class="form-select" data-ue-show-target="select">
       <option value="" disabled selected hidden>Veuillez sélectionner un étudiant</option>
        {% for student in availableStudents %}
          <option value="{{ student.id }}">
            {{ student.name }} {{ student.surname }} - {{ student.email }}
          </option>
        {% endfor %}
      </select>
      <button
        class="btn btn-success"
        data-action="ue-show#addStudent"
        {% if availableStudents|length == 0 %}disabled{% endif %}>
        Ajouter
      </button>
    </div>

    <ul class="list-group" data-ue-show-target="list">
      {% for ins in u_e.inscriptions %}
        <li class="list-group-item" data-user-id="{{ ins.userId.id }}">
          {{ ins.userId.name }} {{ ins.userId.surname }} - {{ ins.userId.email }}
        </li>
        <button class="btn btn-danger btn-sm remove-student-btn" data-student-id="{{ ins.userId.id }}">
        Enlever
      </button>
      {% endfor %}
    </ul>
  </div>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script type="module-shim">
    import { Application, Controller } from 'https://cdn.jsdelivr.net/npm/@hotwired/stimulus@3.2.2/dist/stimulus.js';
    const application = Application.start();

    class UeShowController extends Controller {
      static targets = ['select','list'];

      addStudent() {
        const studentId = this.selectTarget.value;
        fetch('/user/api/add_student', {
          method: 'POST',
          headers: {
            'Accept':           'application/json',
            'Content-Type':     'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({
            ue_id:      {{ u_e.id }},
            student_id: studentId
          })
        })
        .then(r => r.json())
        .then(() => {
          // retirer l’option
          const option = this.selectTarget.querySelector(`option[value="${studentId}"]`);
          const name   = option.textContent;
          option.remove();

          // ajouter dans la liste
          const li = document.createElement('li');
          li.className       = 'list-group-item';
          li.dataset.userId  = studentId;
          li.textContent     = name;
          this.listTarget.appendChild(li);

          // désactiver bouton si plus d’options
          if (!this.selectTarget.options.length) {
            this.element.querySelector('button').disabled = true;
          }
          window.location.reload();
        })
        .catch(console.error);
      }
    }

    application.register('ue-show', UeShowController);

    document.querySelectorAll('.remove-student-btn').forEach(button => {
  button.addEventListener('click', function () {
    const studentId = this.getAttribute('data-student-id');
    console.log("Student id : ", studentId);

    const url = `/user/api/supprimer-etudiant`;

    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({
        user_id: studentId,
        ue_id: {{u_e.id}}
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
      window.location.reload();
      }
    })
    .catch(error => {
      console.error('Error removing student:', error);
    });
  });
});
  </script>
{% endblock %}