{% extends 'base.html.twig' %}

{% block title %}UE index{% endblock %}

{% block body %}
<h1>UE index</h1>

<table class="table">
  <thead>
    <tr>
      <th>Id</th>
      <th>Code</th>
      <th>Title</th>
      <th>Image Path</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for ue in u_es %}
      <tr>
        <td>{{ ue.id }}</td>
        <td>{{ ue.code }}</td>
        <td>{{ ue.title }}</td>
        <td>{{ ue.imagePath }}</td>
        <td>
          <a href="{{ path('app_u_e_admin_show', {'id': ue.id}) }}">show</a>

          <button class="btn btn-success openModifyUEModal"
                  data-ue-id="{{ ue.id }}">
            Modifier
          </button>

          <button class="btn btn-danger delete-ue-btn"
                  data-ue-id="{{ ue.id }}"
                  data-csrf-token="{{ csrf_token('delete' ~ ue.id) }}">
            Supprimer
          </button>
        </td>
      </tr>
    {% else %}
      <tr>
        <td colspan="5">no records found</td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<button class="btn btn-primary" id="openCreateUEModal">
  Ajouter une UE
</button>

<!-- Modal unique pour créer / modifier -->
<div class="modal fade" id="ueModal" tabindex="-1" aria-labelledby="ueModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ueModalLabel"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body" id="ueModalBody">
        <!-- Formulaire injecté ici -->
      </div>
    </div>
  </div>
</div>

<script>
  // AJOUTER
  document.getElementById('openCreateUEModal').addEventListener('click', function () {
    fetch('{{ path('app_u_e_admin_new') }}', {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
      document.getElementById('ueModalLabel').textContent = 'Ajouter une UE';
      document.getElementById('ueModalBody').innerHTML = data.form;
      new bootstrap.Modal(document.getElementById('ueModal')).show();

      const form = document.querySelector('#ueModalBody form');
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(form);

        fetch('{{ path('app_u_e_admin_new') }}', {
          method: 'POST',
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('UE créée avec succès');
            location.reload();
          } else {
            document.getElementById('ueModalBody').innerHTML = data.form;
          }
        });
      });
    });
  });

  // MODIFIER
  document.querySelectorAll('.openModifyUEModal').forEach(button => {
    button.addEventListener('click', function () {
      const ueId = button.getAttribute('data-ue-id');

      fetch(`/ue/admin/${ueId}/edit`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById('ueModalLabel').textContent = 'Modifier une UE';
        document.getElementById('ueModalBody').innerHTML = data.form;
        new bootstrap.Modal(document.getElementById('ueModal')).show();

        const form = document.querySelector('#ueModalBody form');
        form.addEventListener('submit', function (e) {
          e.preventDefault();
          const formData = new FormData(form);

          fetch(`/ue/admin/${ueId}/edit`, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('UE modifiée avec succès');
              location.reload();
            } else {
              document.getElementById('ueModalBody').innerHTML = data.form;
            }
          });
        });
      });
    });
  });

  // SUPPRIMER
  document.querySelectorAll('.delete-ue-btn').forEach(button => {
    button.addEventListener('click', function () {
      const ueId = button.getAttribute('data-ue-id');
      const csrfToken = button.getAttribute('data-csrf-token');

      if (!confirm('Confirmer la suppression de cette UE ?')) return;

      fetch(`/ue/admin/${ueId}`, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({
          _method: 'DELETE',
          _token: csrfToken
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('UE supprimée');
          location.reload();
        } else {
          alert('Erreur : ' + (data.error || 'Suppression échouée'));
        }
      });
    });
  });
</script>
{% endblock %}
