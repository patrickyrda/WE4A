{# Affichage vue detaillée d'une ue pour étudiant#}
{% extends 'base.html.twig' %}
{% block title %}{{ u_e.code }} – {{ u_e.title }}{% endblock %}
{% block head %}
<script src="jquery-3.7.1.min.js"></script>
{% endblock %}
{% block body %}
    <div class="bandeau">
        <a class="connexion" href="{{ path('app_user_dashboard') }}">Mes cours</a>
    </div>
{# Conteneur principal de la vue UE #}
<div class="container">
    <div class="rectangle">
      {# En-tete avec code, le titre et le bouton de création#}
   <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
      {{ u_e.code }} – {{ u_e.title }}
    </h1>
    {% if is_granted('ROLE_TEACHER') %}
      <a class="btn btn-primary"
        id="create-post-btn"
        href=#
        data-ue-id = "{{ u_e.id }}">
        Créer un nouveau post
      </a>
    {% endif %}
  </div>
  {# Bouton pour afficher/cacher la liste des participants #}
  <button
    class="btn btn-info"
    type="button"
    data-bs-toggle="collapse"
    data-bs-target="#participants"
    aria-expanded="false"
    aria-controls="participants"
  >
    Afficher les participants
  </button>
  {# Tableau des participants en zone collapse #}
  <div class="collapse" id="participants">
  <div id="teachers-section">
    <h5>Enseignants</h5>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Prénom</th>
        </tr>
      </thead>
      <tbody id="teachers-table-body">
        <tr>
          <td colspan="2" class="text-center text-muted">Chargement...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div id="students-section" class="mt-4">
    <h5>Étudiants</h5>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Prénom</th>
        </tr>
      </thead>
      <tbody id="students-table-body">
        <tr>
          <td colspan="2" class="text-center text-muted">Chargement...</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>


  <section class="mt-5">
    <a class="btn btn-secondary mt-4"
     href="{{ path('app_user_dashboard') }}">
    ← Retour au tableau de bord
    </a>
    <h2 class="h5 mb-3">Tous les posts</h2>
    {# Conteneur Stimulus pour la liste des posts #}
    <div class="posts-list"
         data-controller="post"
         data-post-target="list">
      {% for post in posts %}
        {% include 'post/item.html.twig' with { post: post } only %}
      {% else %}
        <p class="text-muted">Aucun post pour l’instant.</p>
      {% endfor %}
    </div>
  </section>
    </div>
</div>

{# On ajoute les modals partiels pour crée et modifier les posts#}
{% include 'ue_dashboard/modal.html.twig' %}
{% include 'ue_dashboard/editmodal.html.twig' %}
<script></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>



<script>
//Handle participants list data
document.addEventListener('DOMContentLoaded', () => {
  const ueId = '{{ u_e.id }}'; // assuming this Twig variable gives the UE ID
  const apiUrl = `/user/api/get_participants?ue_id=${ueId}`;
  console.log("Fetching users");

  fetch(apiUrl)
    .then(response => response.json())
    .then(data => {
      if (data.status !== "success") {
        console.error("API error:", data.message);
        return;
      }

      const teachersBody = document.getElementById('teachers-table-body');
      const studentsBody = document.getElementById('students-table-body');

      // Clear loading rows
      teachersBody.innerHTML = '';
      studentsBody.innerHTML = '';

      const { teachers, students } = data.data;

      if (teachers.length === 0) {
        teachersBody.innerHTML = `
          <tr>
            <td colspan="2" class="text-center text-muted">Aucun enseignant.</td>
          </tr>
        `;
      } else {
        teachers.forEach(t => {
          teachersBody.innerHTML += `
            <tr>
              <td>${t.name}</td>
              <td>${t.surname}</td>
            </tr>
          `;
        });
      }

      if (students.length === 0) {
        studentsBody.innerHTML = `
          <tr>
            <td colspan="2" class="text-center text-muted">Aucun étudiant.</td>
          </tr>
        `;
      } else {
        students.forEach(s => {
          studentsBody.innerHTML += `
            <tr>
              <td>${s.name}</td>
              <td>${s.surname}</td>
            </tr>
          `;
        });
      }
    })
    .catch(error => {
      console.error("Fetch failed:", error);
    });
});
</script>



<script>
  
  //Event listener for creating a post
  document.getElementById('create-post-btn').addEventListener('click', function(e) {
    e.preventDefault();
    console.log("Button create post clicked");

    // Get the UE ID from the data attribute
    const ueId = this.getAttribute('data-ue-id');
    console.log("UE ID:", ueId);

    // Send an AJAX request to fetch the form content
    fetch(`{{ path('app_post_new') }}?ue_id=${ueId}`)
      .then(response => response.json())
      .then(data => {
        console.log("inside thendata");
        console.log(data);
        if (data.success) {
          // Insert the form HTML into the modal body
          const decodedForm = new DOMParser().parseFromString(data.form, 'text/html').body.innerHTML;
          document.getElementById('modalContent').innerHTML = decodedForm;

          // Show the modal
          var postModal = new bootstrap.Modal(document.getElementById('postModal'));
          postModal.show();
        } else {
          console.error('Failed to load form.');
        }
      })
      .catch(error => console.error('Error fetching form:', error));
  });


  //Event listener for the modal of saving a post

  document.getElementById('savePost').addEventListener('click', function () {
  const form = document.querySelector('#modalContent form');
  const formData = new FormData(form);

  // Use the same UE ID and endpoint as the first fetch
  const ueId = document.getElementById('create-post-btn').getAttribute('data-ue-id');
  const actionUrl = `{{ path('app_post_new') }}?ue_id=${ueId}`;

  fetch(actionUrl, {
    method: form.method,
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      console.log("Post successfully created!");

      const postModal = bootstrap.Modal.getInstance(document.getElementById('postModal'));
      postModal.hide();
      location.reload();
    } else {
      console.error("Error from API:", data);
      if (data.form) {
        const decodedForm = new DOMParser().parseFromString(data.form, 'text/html').body.innerHTML;
        document.getElementById('modalContent').innerHTML = decodedForm;
      }
    }
  })
  .catch(error => {
    console.error("Error submitting form:", error);
  });
});

let currentPostId = 0;


//Event listener for modifying a post

function addModifierButtonListener() {

    const buttons = document.querySelectorAll('.modifier-buttons');
    
    buttons.forEach(button => {
      
      button.addEventListener('click', function(e) {
        e.preventDefault()
        console.log('Modifier button clicked!');
        const postId = this.getAttribute('data-post-id');
        currentPostId = postId;
        console.log("Post ID:", postId);
        const url = `{{ path('app_post_edit', { id: '__POST_ID__' }) }}`.replace('__POST_ID__', postId);
        // Send an AJAX request to fetch the form content
        fetch(url)
          .then(response => response.json())
          .then(data => {
            console.log("inside thendata");
            console.log(data);
            if (data.success) {
              // Insert the form HTML into the modal body
              const decodedForm = new DOMParser().parseFromString(data.form, 'text/html').body.innerHTML;
              document.getElementById('modalContentEdit').innerHTML = decodedForm;

              // Show the modal
              var postModal = new bootstrap.Modal(document.getElementById('postModalEdit'));
              postModal.show();
            } else {
              console.error('Failed to load form.');
            }
          })
          .catch(error => console.error('Error fetching form:', error));
      });
    });
  }


  //Evenet listener on the button to save a post

  document.getElementById('modifyPost').addEventListener('click', function () {
  const form = document.querySelector('#modalContentEdit form');
  const formData = new FormData(form);

  const postId = currentPostId;
  const actionUrl = `{{ path('app_post_edit', { id: '__POST_ID__' }) }}`.replace('__POST_ID__', postId);

  fetch(actionUrl, {
    method: form.method,
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      console.log("Post successfully modified!");

      const postModal = bootstrap.Modal.getInstance(document.getElementById('postModalEdit'));
      postModal.hide();
      location.reload();
    } else {
      console.error("Error from API:", data);
      if (data.form) {
        // Re-insert the form with validation errors or other feedback
        const decodedForm = new DOMParser().parseFromString(data.form, 'text/html').body.innerHTML;
        document.getElementById('modalContentEdit').innerHTML = decodedForm;
      }
    }
  })
  .catch(error => {
    console.error("Error submitting form:", error);
  });
});

  document.addEventListener('DOMContentLoaded', addModifierButtonListener);

//Handle Post deletion
document.addEventListener('submit', function (event) {
  const form = event.target.closest('.ajax-delete-form-post');
  if (form) {
    event.preventDefault();

    if (!confirm('Êtes-vous sûr de vouloir supprimer ce post ?')) return;

    const formData = new FormData(form);
    const actionUrl = form.getAttribute('action');

    fetch(actionUrl, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        window.location.reload();
        if (row) row.remove();
      } else {
        console.error('Erreur lors de la suppression.');
      }
    })
    .catch(error => console.error('Erreur AJAX:', error));
  }
});
</script>
{% endblock %}