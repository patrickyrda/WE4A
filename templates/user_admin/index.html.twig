{# Page dashboard des utilisateurs #}
{% extends 'base.html.twig' %}

{% block title %}Administration des utilisateurs{% endblock %}

{% block body %}
{# Conteneur avec controller Stimulus pour chargement dynamique #}
<div class="container my-5" data-controller="admin-dashboard">
  <h1 class="mb-4">Gestion des utilisateurs</h1>

  {# Bouton pour créer un nouvel utilisateur #}
  <a href="{{ path('app_user_admin_new') }}" class="btn btn-success mb-3">
    + Nouvel utilisateur
  </a>

  {# Conteneur de la table des utilisateurs, mis à jour via AJAX #}
  <div id="user-table-container">
    {{ include('user_admin/_table.html.twig', { users: users }) }}
  </div>
</div>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script type="module">
    import { Application, Controller } from 'https://cdn.jsdelivr.net/npm/@hotwired/stimulus@3.2.2/dist/stimulus.js';
    const application = Application.start();

    {# Controller Stimulus pour recharger la table des utilisateurs en AJAX #}
    class AdminDashboardController extends Controller {
      connect() {
        this.loadUserTable();
      }

      loadUserTable() {
        fetch('{{ path('app_admin_dashboard') }}', {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(r => r.json())
        .then(json => {
          if (json.success) {
            {# Injection du fragment HTML retourné #}
            document
              .getElementById('user-table-container')
              .innerHTML = json.html;
          }
        })
        .catch(err => console.error('Erreur AJAX', err));
      }
    }
    {# Enregistrement du controller sous le nom 'admin-dashboard' #}
    application.register('admin-dashboard', AdminDashboardController);
  </script>
{% endblock %}