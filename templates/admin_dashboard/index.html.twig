{% extends 'base.html.twig' %}

{% block title %}Tableau de bord Admin{% endblock %}

{% block body %}
  <div class="container">

  <div class="rectangle">
  <div data-controller="admin-dashboard" data-admin-dashboard-active-value="ue">
    <h1>Admin page</h1>
    <div class="mb-4">
      <button
        type="button"
        class="btn btn-primary me-2"
        data-action="click->admin-dashboard#loadUeTable"
      >
        Gérer les UE
      </button>

      <button
        type="button"
        class="btn btn-secondary"
        data-action="click->admin-dashboard#loadUserTable"
      >
        Gérer les utilisateurs
      </button>
    </div>
    <div id="ue-container" data-admin-dashboard-target="ueContainer">
      {{ render(path('app_u_e_admin_index', { _format:'html' })) }}
    </div>
    <div id="ue-table-container"></div>
    <div id="user-table-container"></div>
  </div>
  </div>
  </div>
  {% include 'admin_dashboard/modal.html.twig' %}
  {% include 'admin_dashboard/editmodal.html.twig' %}
  {% include 'admin_dashboard/modalue.html.twig' %}
  {% include 'admin_dashboard/editmodalue.html.twig' %}
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script type="module">
    import { Application, Controller } from 'https://cdn.jsdelivr.net/npm/@hotwired/stimulus@3.2.2/dist/stimulus.js';
    const application = Application.start();

    class AdminDashboardController extends Controller {
      loadUeTable(event) {
        event.preventDefault();
        this._fetchAndInject(
          '{{ path('app_u_e_admin_index') }}',
          'ue-table-container'
        );
      }

      loadUserTable(event) {
        event.preventDefault();
        this._fetchAndInject(
          '{{ path('app_user_admin_index') }}',
          'user-table-container'
        );
      }

      _fetchAndInject(url, containerId) {
        if (containerId === 'ue-table-container') {
          document.getElementById('user-table-container').innerHTML = '';
        } else {
          document.getElementById('ue-table-container').innerHTML = '';
        }

        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
          .then(r => {
            if (!r.ok) throw new Error(`Status ${r.status}`);
            return r.json();
          })
          .then(json => {
            if (json.success) {
              document.getElementById(containerId).innerHTML = json.html;
            } else {
              console.error('Erreur AJAX', json);
            }
          })
          .catch(err => console.error('Erreur AJAX', err));
      }
    }

    application.register('admin-dashboard', AdminDashboardController);



    document.addEventListener('click', function (event) {
    const target = event.target.closest('#btn-add-user');
    if (target) {
      event.preventDefault();


      fetch('{{ path("app_user_admin_new") }}', {
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.form) {
            // Insert the form HTML into the modal body
            const decodedForm = new DOMParser().parseFromString(data.form, 'text/html').body.innerHTML;
            document.getElementById('modalContent').innerHTML = decodedForm;

            // Show the modal
            const userModal = new bootstrap.Modal(document.getElementById('userModal'));
            userModal.show();
          } else {
            console.error('Failed to load user creation form.');
          }
        })
        .catch(error => console.error('Error fetching form:', error));
      }
   });

  document.getElementById('saveUser').addEventListener('click', function () {
  const form = document.querySelector('#modalContent form');
  const formData = new FormData(form);
  const actionUrl = '{{ path("app_user_admin_new") }}';

  fetch(actionUrl, {
    method: form.method,
    body: formData,
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      console.log("User successfully created!");

      const userModal = bootstrap.Modal.getInstance(document.getElementById('userModal'));
      userModal.hide();

      // Refresh the page or update your user list
      location.reload();
    } else {
      console.error("Server returned error:", data);

      if (data.form) {
        const decodedForm = new DOMParser().parseFromString(data.form, 'text/html').body.innerHTML;
        document.getElementById('modalContent').innerHTML = decodedForm;
      }
    }
  })
  .catch(error => {
    console.error("Error submitting form:", error);
  });
});

  let currentUserId = 0;

  // Edit button delegation (Turbo-compatible)
  document.addEventListener('click', function (event) {
    const target = event.target.closest('.edit-button-user');
    if (target) {
      event.preventDefault();

      const userId = target.getAttribute('data-user-id');
      currentUserId = userId;

      const url = `{{ path('app_user_admin_edit', { id: 'USER_ID' }) }}`.replace('USER_ID', userId);

      fetch(url, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.form) {
          const decodedForm = new DOMParser().parseFromString(data.form, 'text/html').body.innerHTML;
          document.getElementById('modalContentEdit').innerHTML = decodedForm;

          const modal = new bootstrap.Modal(document.getElementById('userModalEdit'));
          modal.show();
        } else {
          console.error('No form returned from server.');
        }
      })
      .catch(error => console.error('Fetch form error:', error));
    }
  });

  // Submit edited form via AJAX
  document.addEventListener('click', function (event) {
    if (event.target.id === 'modifyUser') {
      event.preventDefault();

      const form = document.querySelector('#modalContentEdit form');
      const formData = new FormData(form);

      const url = `{{ path('app_user_admin_edit', { id: 'USER_ID' }) }}`.replace('USER_ID', currentUserId);

      fetch(url, {
        method: form.method,
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const modal = bootstrap.Modal.getInstance(document.getElementById('userModalEdit'));
          modal.hide();
          location.reload();
        } else if (data.form) {
          const decodedForm = new DOMParser().parseFromString(data.form, 'text/html').body.innerHTML;
          document.getElementById('modalContentEdit').innerHTML = decodedForm;
        } else {
          console.error('Unknown error submitting form:', data);
        }
      })
      .catch(error => console.error('Submit error:', error));
    }
  });

  //pour les ues
  let currentUeId = 0;

// Handle UE creation
document.addEventListener('click', function (event) {
  const target = event.target.closest('#btn-add-ue');
  if (target) {
    event.preventDefault();

    fetch('{{ path("app_u_e_admin_new") }}', {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.form) {
        const decodedForm = new DOMParser().parseFromString(data.form, 'text/html').body.innerHTML;
        document.getElementById('modalUeContent').innerHTML = decodedForm;

        const ueModal = new bootstrap.Modal(document.getElementById('ueModal'));
        ueModal.show();
      } else {
        console.error('Form not received for UE creation.');
      }
    })
    .catch(error => console.error('Error fetching UE form:', error));
  }
});

// Submit UE creation form
document.addEventListener('click', function (event) {
  if (event.target.id === 'saveUe') {
    const form = document.querySelector('#modalUeContent form');
    const formData = new FormData(form);
    const actionUrl = '{{ path("app_u_e_admin_new") }}';

    fetch(actionUrl, {
      method: form.method,
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        bootstrap.Modal.getInstance(document.getElementById('ueModal')).hide();
        location.reload();
      } else if (data.form) {
        const decodedForm = new DOMParser().parseFromString(data.form, 'text/html').body.innerHTML;
        document.getElementById('modalUeContent').innerHTML = decodedForm;
      } else {
        console.error('Error creating UE:', data);
      }
    })
    .catch(error => console.error('Error submitting UE form:', error));
  }
});

// Handle UE editing
document.addEventListener('click', function (event) {
  const target = event.target.closest('.edit-button-ue');
  if (target) {
    event.preventDefault();

    currentUeId = target.getAttribute('data-ue-id');
    const url = `{{ path('app_u_e_admin_edit', { id: 'UE_ID' }) }}`.replace('UE_ID', currentUeId);

    fetch(url, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.form) {
        const decodedForm = new DOMParser().parseFromString(data.form, 'text/html').body.innerHTML;
        document.getElementById('modalUeContentEdit').innerHTML = decodedForm;

        const ueEditModal = new bootstrap.Modal(document.getElementById('ueModalEdit'));
        ueEditModal.show();
      } else {
        console.error('No form received for UE editing.');
      }
    })
    .catch(error => console.error('Error loading UE edit form:', error));
  }
});

// Submit UE edit form
document.addEventListener('click', function (event) {
  if (event.target.id === 'modifyUe') {
    event.preventDefault();

    const form = document.querySelector('#modalUeContentEdit form');
    const formData = new FormData(form);
    const url = `{{ path('app_u_e_admin_edit', { id: 'UE_ID' }) }}`.replace('UE_ID', currentUeId);

    fetch(url, {
      method: form.method,
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        bootstrap.Modal.getInstance(document.getElementById('ueModalEdit')).hide();
        location.reload();
      } else if (data.form) {
        const decodedForm = new DOMParser().parseFromString(data.form, 'text/html').body.innerHTML;
        document.getElementById('modalUeContentEdit').innerHTML = decodedForm;
      } else {
        console.error('Error updating UE:', data);
      }
    })
    .catch(error => console.error('Error submitting edited UE form:', error));
  }
});

//Handle UE deletion 
document.addEventListener('submit', function (event) {
  const form = event.target.closest('.ajax-delete-form-ue');
  if (form) {
    event.preventDefault();

    if (!confirm('Êtes-vous sûr de vouloir supprimer cet ue ?')) return;

    const formData = new FormData(form);
    const actionUrl = form.getAttribute('action');

    fetch(actionUrl, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const row = form.closest('tr');
        if (row) row.remove();
      } else {
        console.error('Erreur lors de la suppression.');
      }
    })
    .catch(error => console.error('Erreur AJAX:', error));
  }
});

//Handle User deletion
document.addEventListener('submit', function (event) {
  const form = event.target.closest('.ajax-delete-form-user');
  if (form) {
    event.preventDefault();

    if (!confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur ?')) return;

    const formData = new FormData(form);
    const actionUrl = form.getAttribute('action');

    fetch(actionUrl, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const row = form.closest('tr');
        if (row) row.remove();
      } else {
        console.error('Erreur lors de la suppression.');
      }
    })
    .catch(error => console.error('Erreur AJAX:', error));
  }
});
  </script>
  
{% endblock %}
